<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medagliere WCA - Italia</title>
    <style>
        body {
            font-family: sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Medagliere WCA - Italia</h1>
    <div id="results-container">
        <p>Caricamento dati. Attendere, potrebbe volerci del tempo...</p>
    </div>

    <script>
        const competitionApiUrl = 'https://www.worldcubeassociation.org/api/v0/competitions';
        const resultsApiUrl = 'https://www.worldcubeassociation.org/api/v0/results';
        
        async function fetchMedals() {
            const container = document.getElementById('results-container');
            const countryId = 'IT';
            
            try {
                // Passo 1: Scarica un set di competizioni più grande e filtra
                const competitionsResponse = await fetch(`${competitionApiUrl}?per_page=10000`);
                if (!competitionsResponse.ok) {
                    throw new Error(`HTTP Error! Status: ${competitionsResponse.status}`);
                }
                const allCompetitions = await competitionsResponse.json();
                const italianCompetitions = allCompetitions.filter(comp => comp.country_iso2 === countryId);

                if (italianCompetitions.length === 0) {
                    container.innerHTML = `<p style="color: red;">Nessuna competizione italiana trovata nel set di dati.</p>`;
                    return;
                }

                // Passo 2: Scarica i risultati per ogni competizione italiana
                let allResults = [];
                for (const comp of italianCompetitions) {
                    const resultsResponse = await fetch(`${resultsApiUrl}?competition_id=${comp.id}`);
                    if (resultsResponse.ok) {
                        const newResults = await resultsResponse.json();
                        allResults = allResults.concat(newResults);
                    }
                }

                if (allResults.length === 0) {
                    container.innerHTML = `<p>Nessun risultato trovato per le competizioni italiane.</p>`;
                    return;
                }

                // Passo 3: Calcolo delle medaglie
                const playerStats = {};
                allResults.forEach(result => {
                    if (result.pos <= 3 && result.person_name) {
                        const personId = result.person_id;
                        if (!playerStats[personId]) {
                            playerStats[personId] = {
                                wcaId: personId,
                                name: result.person_name,
                                golds: 0,
                                silvers: 0,
                                bronzes: 0,
                                tot: 0
                            };
                        }
                        if (result.pos === 1) playerStats[personId].golds++;
                        if (result.pos === 2) playerStats[personId].silvers++;
                        if (result.pos === 3) playerStats[personId].bronzes++;
                        playerStats[personId].tot++;
                    }
                });

                // Passo 4: Ordina i risultati
                const sortedPlayers = Object.values(playerStats).sort((a, b) => {
                    if (b.golds !== a.golds) return b.golds - a.golds;
                    if (b.silvers !== a.silvers) return b.silvers - a.silvers;
                    return b.bronzes - a.bronzes;
                });
                
                // Passo 5: Crea e visualizza la tabella HTML
                let html = '<table><thead><tr><th>WCA ID</th><th>Nome</th><th>Ori</th><th>Argenti</th><th>Bronzi</th><th>Totale</th></tr></thead><tbody>';
                sortedPlayers.forEach(player => {
                    html += `<tr><td>${player.wcaId}</td><td>${player.name}</td><td>${player.golds}</td><td>${player.silvers}</td><td>${player.bronzes}</td><td>${player.tot}</td></tr>`;
                });
                html += '</tbody></table>';

                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `<p style="color: red;">Errore nel caricamento dei dati: ${error.message}. Riprova più tardi.</p>`;
                console.error('Fetch error:', error);
            }
        }
        
        fetchMedals();
    </script>
</body>
</html>
