<script>
    document.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById('results-container');
        container.innerHTML = `<p>Caricamento dati...</p>`;

        // ID dell'evento, come da tua query. L'API usa stringhe diverse.
        const eventId = '333'; 

        // Endpoint per scaricare i risultati
        const resultsUrl = 'https://www.worldcubeassociation.org/api/v0/results?sort=best&per_page=1000';

        fetch(resultsUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore nel caricamento dei dati: ' + response.statusText);
                }
                return response.json();
            })
            .then(allResults => {
                // Aggrega le medaglie usando la logica della tua query SQL
                const playerStats = {};

                allResults.forEach(result => {
                    // Controlla l'evento, il round (finale), e la posizione
                    if (result.event_id === eventId && result.round_type === 'f' && result.pos <= 3) {
                        const personId = result.person_id;
                        if (!playerStats[personId]) {
                            playerStats[personId] = {
                                name: result.person_name,
                                golds: 0,
                                silvers: 0,
                                bronzes: 0,
                                tot: 0
                            };
                        }
                        
                        if (result.pos === 1) playerStats[personId].golds++;
                        if (result.pos === 2) playerStats[personId].silvers++;
                        if (result.pos === 3) playerStats[personId].bronzes++;
                        playerStats[personId].tot++;
                    }
                });

                // Converti l'oggetto in un array per ordinarlo
                const sortedPlayers = Object.values(playerStats).sort((a, b) => {
                    // Ordina per numero totale di medaglie (come nella tua query)
                    return b.tot - a.tot;
                });

                // Crea la tabella dei risultati
                let html = '<h2>Classifica Medaglie 3x3x3 (top 1000)</h2><table><thead><tr><th>Nome</th><th>Ori</th><th>Argenti</th><th>Bronzi</th><th>Tot</th></tr></thead><tbody>';
                sortedPlayers.slice(0, 10).forEach(player => { // Mostra solo i primi 10
                    html += `<tr><td>${player.name}</td><td>${player.golds}</td><td>${player.silvers}</td><td>${player.bronzes}</td><td>${player.tot}</td></tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            })
            .catch(error => {
                container.innerHTML = `<p style="color: red;">Errore nel caricamento dei dati: ${error.message}</p>`;
                console.error('Fetch error:', error);
            });
    });
</script>
